name: Deploy WordPress via Helm

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
      
      - name: Setup Helm
        uses: azure/setup-helm@v3
      
      - name: Configure Kubernetes context
        run: |
          echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > ~/.kube/config
          chmod 600 ~/.kube/config
      
      - name: Add Bitnami repo
        run: helm repo add bitnami https://charts.bitnami.com/bitnami && helm repo update
      
      - name: Deploy WordPress
        run: |
          kubectl create namespace wordpress-ci --dry-run=client -o yaml | kubectl apply -f -
          helm upgrade --install my-wordpress bitnami/wordpress \
            --namespace wordpress-ci \
            --set service.type=ClusterIP \
            --set mariadb.auth.password=securepass2026 \
            --set wordpressPassword=adminpass2026
      
      - name: Verify deployment
        run: |
          kubectl rollout status deployment/my-wordpress -n wordpress-ci --timeout=180s
          echo "âœ… WordPress deployed successfully!"